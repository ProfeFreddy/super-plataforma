import{u as ye,X as Ee,r as o,h as k,o as he,R as e,d as y,e as E,i as N,f as P,s as D,p as ve}from"./index-BqLPJdMO.js";const H=(p="")=>p.toString().toLowerCase().normalize("NFD").replace(new RegExp("\\p{Diacritic}","gu"),"").replace(/\s+/g,""),xe=(p,c,s)=>[H(p),H(c),String(s||"")].filter(Boolean).join("_"),Y=async()=>{var c;return(c=k.currentUser)!=null&&c.uid?k.currentUser.uid:(await ve(k)).user.uid},I=p=>({padding:".5rem .8rem",border:"none",borderRadius:8,color:"#fff",cursor:"pointer",background:p}),F={background:"#fff",border:"1px solid #e5e7eb",borderRadius:12,padding:"1rem",boxShadow:"0 6px 18px rgba(16,24,40,.06), 0 2px 6px rgba(16,24,40,.03)"};function we(){var Q;const p=ye(),[c]=Ee(),s=c.get("asig")||"",u=c.get("nivel")||"",m=c.get("unidadId")||"",S=c.get("planId")||xe(s,u,m),x=c.get("slot")||"",[b,X]=o.useState(((Q=k.currentUser)==null?void 0:Q.uid)||""),[Z,K]=o.useState(!0),[V,R]=o.useState(!1),[J,f]=o.useState(""),[B,ee]=o.useState(""),[O,te]=o.useState([]),[A,ae]=o.useState([]),[C,ne]=o.useState(45),[M,W]=o.useState(S),[l,g]=o.useState([]),[$,re]=o.useState(s),[T,le]=o.useState(u);o.useEffect(()=>{const a=he(k,async t=>{if(t!=null&&t.uid)X(t.uid);else{const n=await Y();X(n)}});return()=>a()},[]),o.useEffect(()=>{if(!b)return;(async()=>{var t,n;K(!0);try{try{const i=y(E,"usuarios",b),d=await N(i);if(d.exists()){const v=((t=d.data())==null?void 0:t.horarioConfig)||{};Number.isFinite(+v.duracionMin)&&ne(Number(v.duracionMin))}}catch{}let r=null;try{const i=y(E,"catalogo_curricular",s,"niveles",u,"unidades",m),d=await N(i);d.exists()&&(r=d.data())}catch{}if(!r)try{const i=y(E,"catalogo_curricular",`${s}_${u}`,"unidades",m),d=await N(i);d.exists()&&(r=d.data())}catch{}const L=(r==null?void 0:r.nombre)||(r==null?void 0:r.titulo)||`Unidad ${m}`,z=Array.isArray(r==null?void 0:r.objetivos)?r.objetivos:Array.isArray(r==null?void 0:r.OA)?r.OA:[],be=Array.isArray(r==null?void 0:r.habilidades)?r.habilidades:[];ee(L),te(z),ae(be);try{const i=await N(y(E,"catalogo_curricular",s));i.exists()&&((n=i.data())!=null&&n.nombre)&&re(i.data().nombre)}catch{}le(u);try{const i=y(E,"planes_clase",b,"planes",S),d=await N(i);if(d.exists()){const v=d.data()||{};W(S);const q=Array.isArray(v.items)?v.items:[];g(q.map((w,fe)=>({id:w.id??`it-${fe+1}`,texto:w.texto??"",durMin:Number(w.durMin)||10,done:!!w.done})))}else{const v=z.length>0?Math.max(5,Math.round(C/z.length)):10;W(S),g(z.map((q,w)=>({id:`oa-${w+1}`,texto:q,durMin:v,done:!1})))}}catch(i){console.warn("load plan error:",i)}}finally{K(!1)}})()},[b,s,u,m,S]);const _=o.useMemo(()=>l.reduce((a,t)=>a+(Number(t.durMin)||0),0),[l]),j=l.length>0&&Number.isFinite(+C)&&_>Number(C),oe=a=>{if(a<=0)return;const t=[...l],n=t[a-1];t[a-1]=t[a],t[a]=n,g(t)},se=a=>{if(a>=l.length-1)return;const t=[...l],n=t[a+1];t[a+1]=t[a],t[a]=n,g(t)},ie=(a,t)=>{const n=[...l];n[a]={...n[a],durMin:Math.max(1,Number(t)||1)},g(n)},de=(a,t)=>{const n=[...l];n[a]={...n[a],texto:t},g(n)},ce=()=>{g([...l,{id:`new-${Date.now()}`,texto:"",durMin:10,done:!1}])},ue=a=>{const t=[...l];t.splice(a,1),g(t)},me=()=>{const a=O.length>0?Math.max(5,Math.round(C/O.length)):10;g(O.map((t,n)=>({id:`oa-${n+1}`,texto:t,durMin:a,done:!1})))},ge=async()=>{b||await Y(),R(!0),f("Guardando plan...");try{const a={planId:M,asigId:s,nivelId:u,unidadId:m,unidadNombre:B,items:l.map(t=>({id:t.id,texto:t.texto,durMin:Number(t.durMin)||0,done:!1})),meta:{asigNombre:$,nivelNombre:T,habilidades:A},updatedAt:P()};await D(y(E,"planes_clase",b,"planes",M),a,{merge:!0}),f("✓ Plan guardado."),setTimeout(()=>f(""),1500)}catch(a){f(`Error: ${(a==null?void 0:a.message)||a}`)}finally{R(!1)}},pe=async()=>{var a;if(!x){alert("No se recibió ?slot=fila-col en la URL.");return}if(l.length===0){alert("Tu plan no tiene objetivos. Agrega al menos uno.");return}try{R(!0),f("Aplicando al slot...");const t=((a=l[0])==null?void 0:a.texto)||"",n=l.map((r,L)=>({idx:L,texto:r.texto,durMin:Number(r.durMin)||0,done:!1}));await D(y(E,"clases_detalle",b,"slots",x),{planId:M,asigId:s,asignaturaId:s,asignatura:$||s,nivel:T||u,nivelId:u,unidad:B,unidadId:m,objetivo:t,habilidades:(A||[]).join("  "),oaPlan:n,oaIndex:0,oaAppliedAt:P(),updatedAt:P()},{merge:!0}),await D(y(E,"horarios",b,"celdas",x),{planId:M,codUnidad:m,asignaturaId:s,nivelId:u,updatedAt:P()},{merge:!0}),f("✓ Plan aplicado al slot."),setTimeout(()=>f(""),1500)}catch(t){f(`Error: ${(t==null?void 0:t.message)||t}`)}finally{R(!1)}};return Z?e.createElement("div",{style:{padding:"1.25rem"}},e.createElement("h2",null,"Planificador de Clase"),"Cargando…"):e.createElement("div",{style:{padding:"1.25rem",display:"grid",gap:12}},e.createElement("div",{style:{display:"flex",alignItems:"center",gap:8}},e.createElement("button",{type:"button",onClick:()=>p(-1),style:I("#475569")},"← Volver"),e.createElement("h2",{style:{margin:0}},"Planificador de Clase")),e.createElement("div",{style:F},e.createElement("div",{style:{fontSize:14,color:"#475569",marginBottom:6}},e.createElement("b",null,"Asignatura:")," ",$,"  ·  ",e.createElement("b",null,"Nivel:")," ",T,e.createElement("br",null),e.createElement("b",null,"Unidad:")," ",B," (",m,")"),e.createElement("div",{style:{display:"flex",flexWrap:"wrap",gap:10,alignItems:"center"}},e.createElement("div",null,e.createElement("div",{style:{fontSize:12,color:"#64748b"}},"Plan ID"),e.createElement("input",{value:M,onChange:a=>W(H(a.target.value)),style:{border:"1px solid #e5e7eb",borderRadius:8,padding:".4rem .6rem",minWidth:260}})),e.createElement("div",null,e.createElement("div",{style:{fontSize:12,color:"#64748b"}},"Duración del bloque"),e.createElement("div",{style:{border:"1px solid #e5e7eb",borderRadius:8,padding:".4rem .6rem",minWidth:100}},C," min")),e.createElement("div",null,e.createElement("div",{style:{fontSize:12,color:"#64748b"}},"Duración total"),e.createElement("div",{style:{border:"1px solid #e5e7eb",borderRadius:8,padding:".4rem .6rem",minWidth:120,background:j?"#fff7ed":"#f8fafc"},title:j?"La suma supera la duración del bloque":"OK dentro del bloque"},_," min ",j?" (⚠ supera el bloque)":"")),e.createElement("div",{style:{marginLeft:"auto",display:"flex",gap:8}},e.createElement("button",{onClick:ge,disabled:V,style:I("#2563eb"),title:"Guardar este plan"},"Guardar plan"),x&&e.createElement("button",{onClick:pe,disabled:V,style:I("#059669"),title:`Aplicar al slot ${x}`},"Aplicar al slot ",x))),J&&e.createElement("div",{style:{marginTop:8,fontSize:13,color:"#334155"}},J)),e.createElement("div",{style:{...F,overflowX:"auto"}},e.createElement("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:8}},e.createElement("h3",{style:{margin:0}},"Objetivos de Aprendizaje"),e.createElement("div",{style:{display:"flex",gap:8}},e.createElement("button",{onClick:me,style:I("#7c3aed"),title:"Recrear lista desde el catálogo"},"Reset desde catálogo"),e.createElement("button",{onClick:ce,style:I("#0ea5e9"),title:"Agregar objetivo manual"},"+ Agregar OA"))),l.length===0?e.createElement("div",{style:{color:"#64748b"}},"No hay objetivos. Usa “Reset desde catálogo” o “+ Agregar OA”."):e.createElement("table",{style:{width:"100%",borderCollapse:"collapse",minWidth:720}},e.createElement("thead",null,e.createElement("tr",null,e.createElement("th",{style:U},"#"),e.createElement("th",{style:U},"Objetivo"),e.createElement("th",{style:U},"Min"),e.createElement("th",{style:U},"Acciones"))),e.createElement("tbody",null,l.map((a,t)=>e.createElement("tr",{key:a.id},e.createElement("td",{style:h},t+1),e.createElement("td",{style:{...h,width:"100%"}},e.createElement("textarea",{value:a.texto,onChange:n=>de(t,n.target.value),rows:3,style:{width:"100%",border:"1px solid #e5e7eb",borderRadius:8,padding:".5rem .6rem",resize:"vertical"}})),e.createElement("td",{style:h},e.createElement("input",{type:"number",min:1,value:a.durMin,onChange:n=>ie(t,n.target.value),style:{width:80,border:"1px solid #e5e7eb",borderRadius:8,padding:".35rem .5rem"}})),e.createElement("td",{style:h},e.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},e.createElement("button",{onClick:()=>oe(t),style:G,title:"Subir"},"↑"),e.createElement("button",{onClick:()=>se(t),style:G,title:"Bajar"},"↓"),e.createElement("button",{onClick:()=>ue(t),style:{...G,background:"#ef4444"},title:"Eliminar"},"✕"))))),e.createElement("tr",null,e.createElement("td",{style:h}),e.createElement("td",{style:{...h,textAlign:"right",fontWeight:600}},"Total"),e.createElement("td",{style:{...h,fontWeight:700}},_," min ",j?" (⚠)":""),e.createElement("td",{style:h}))))),(A==null?void 0:A.length)>0&&e.createElement("div",{style:F},e.createElement("div",{style:{fontSize:14,color:"#475569",marginBottom:6}},e.createElement("b",null,"Habilidades asociadas (catálogo):")),e.createElement("div",{style:{display:"flex",gap:6,flexWrap:"wrap"}},A.map((a,t)=>e.createElement("span",{key:t,style:{border:"1px solid #cbd5e1",background:"#f8fafc",borderRadius:999,padding:"6px 10px",fontSize:13}},a)))))}const U={textAlign:"left",borderBottom:"1px solid #e5e7eb",padding:".5rem .5rem",fontWeight:700,fontSize:13,color:"#334155"},h={borderBottom:"1px solid #f1f5f9",padding:".5rem .5rem",verticalAlign:"top",fontSize:14,color:"#0f172a"},G={border:"none",borderRadius:6,background:"#2563eb",color:"#fff",padding:".3rem .5rem",cursor:"pointer"};export{we as default};
